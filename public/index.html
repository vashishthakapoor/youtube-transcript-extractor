<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Transcript Fetcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .transcript-line:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <div class="glass-effect rounded-2xl p-8 mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
                    üé• YouTube Transcript Fetcher
                </h1>
                <p class="text-lg text-gray-200 max-w-2xl mx-auto">
                    Extract transcripts from YouTube videos using the Oxylabs API. 
                    Support for multiple languages and transcript types.
                </p>
            </div>
        </header>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Input Form -->
            <div class="glass-effect rounded-2xl p-8 mb-8">
                <form id="transcriptForm" class="space-y-6">
                    <!-- Video URL Input -->
                    <div>
                        <label for="videoUrl" class="block text-sm font-medium text-white mb-2">
                            YouTube Video URL or ID
                        </label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="videoUrl" 
                                placeholder="https://www.youtube.com/watch?v=... or video ID"
                                class="w-full px-4 py-3 pl-12 bg-white/10 border border-gray-300/30 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                required
                            >
                            <i data-lucide="youtube" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-300 w-5 h-5"></i>
                        </div>
                    </div>

                    <!-- Language and Origin Selection -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label for="language" class="block text-sm font-medium text-white mb-2">
                                Language
                            </label>
                            <select 
                                id="language" 
                                class="w-full px-4 py-3 bg-white/10 border border-gray-300/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            >
                                <option value="en">English</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="it">Italian</option>
                                <option value="pt">Portuguese</option>
                                <option value="ru">Russian</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="zh">Chinese</option>
                            </select>
                        </div>
                        <div>
                            <label for="origin" class="block text-sm font-medium text-white mb-2">
                                Transcript Type
                            </label>
                            <select 
                                id="origin" 
                                class="w-full px-4 py-3 bg-white/10 border border-gray-300/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            >
                                <option value="uploader_provided">Uploader Provided</option>
                                <option value="auto_generated">Auto Generated</option>
                            </select>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button 
                        type="submit" 
                        id="submitBtn"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-transparent flex items-center justify-center"
                    >
                        <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                        <span id="submitText">Fetch Transcript</span>
                    </button>
                </form>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="glass-effect rounded-2xl p-8 mb-8 hidden">
                <div class="flex items-center justify-center space-x-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
                    <span class="text-white text-lg">Fetching transcript...</span>
                </div>
            </div>

            <!-- Error Display -->
            <div id="error" class="bg-red-500/20 border border-red-500/50 rounded-2xl p-8 mb-8 hidden">
                <div class="flex items-start space-x-3">
                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <h3 class="text-red-400 font-medium text-lg mb-2">Error</h3>
                        <p id="errorMessage" class="text-red-300"></p>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="results" class="glass-effect rounded-2xl p-8 hidden">
                <!-- Results Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-2">Transcript</h2>
                        <div class="flex items-center space-x-4 text-sm text-gray-300">
                            <span id="videoInfo"></span>
                            <span id="transcriptStats"></span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button 
                            id="copyBtn"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center"
                        >
                            <i data-lucide="copy" class="w-4 h-4 mr-2"></i>
                            Copy
                        </button>
                        <button 
                            id="downloadBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center"
                        >
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            Download
                        </button>
                    </div>
                </div>

                <!-- Search -->
                <div class="mb-6">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search in transcript..."
                            class="w-full px-4 py-2 pl-10 bg-white/10 border border-gray-300/30 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        >
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-300 w-4 h-4"></i>
                    </div>
                </div>

                <!-- Transcript Content -->
                <div id="transcriptContent" class="bg-black/20 rounded-xl p-6 max-h-96 overflow-y-auto">
                    <!-- Transcript lines will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="max-w-4xl mx-auto mt-12">
            <div class="glass-effect rounded-2xl p-8">
                <h3 class="text-2xl font-bold text-white mb-6 text-center">Features</h3>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="bg-indigo-600/20 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="globe" class="w-8 h-8 text-indigo-400"></i>
                        </div>
                        <h4 class="text-white font-semibold mb-2">Multi-Language</h4>
                        <p class="text-gray-300 text-sm">Support for 10+ languages including English, Spanish, French, and more</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-green-600/20 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="search" class="w-8 h-8 text-green-400"></i>
                        </div>
                        <h4 class="text-white font-semibold mb-2">Smart Search</h4>
                        <p class="text-gray-300 text-sm">Search through transcripts with real-time highlighting and filtering</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-purple-600/20 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="download" class="w-8 h-8 text-purple-400"></i>
                        </div>
                        <h4 class="text-white font-semibold mb-2">Export Options</h4>
                        <p class="text-gray-300 text-sm">Copy to clipboard or download as text file for easy sharing</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-300">
            <p>Built with ‚ù§Ô∏è using Tailwind CSS and Oxylabs API</p>
            <div class="flex justify-center space-x-4 mt-4">
                <a href="/api/health" class="text-sm hover:text-white transition-colors">API Status</a>
                <span class="text-gray-500">‚Ä¢</span>
                <a href="/docs" class="text-sm hover:text-white transition-colors">API Docs</a>
                <span class="text-gray-500">‚Ä¢</span>
                <a href="https://github.com" class="text-sm hover:text-white transition-colors">GitHub</a>
            </div>
        </footer>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // DOM elements
        const form = document.getElementById('transcriptForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        const results = document.getElementById('results');
        const transcriptContent = document.getElementById('transcriptContent');
        const videoInfo = document.getElementById('videoInfo');
        const transcriptStats = document.getElementById('transcriptStats');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const searchInput = document.getElementById('searchInput');

        let currentTranscript = '';
        let currentVideoId = '';

        // Extract video ID from URL
        function extractVideoId(input) {
            const patterns = [
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
                /^([a-zA-Z0-9_-]{11})$/
            ];

            for (const pattern of patterns) {
                const match = input.match(pattern);
                if (match) return match[1];
            }
            throw new Error('Invalid YouTube URL or video ID');
        }

        // Show/hide elements
        function showElement(element) {
            element.classList.remove('hidden');
        }

        function hideElement(element) {
            element.classList.add('hidden');
        }

        // Show error
        function showError(message) {
            errorMessage.textContent = message;
            showElement(error);
            hideElement(loading);
        }

        // Set loading state
        function setLoading(isLoading) {
            if (isLoading) {
                submitText.textContent = 'Fetching...';
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                showElement(loading);
                hideElement(error);
                hideElement(results);
            } else {
                submitText.textContent = 'Fetch Transcript';
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                hideElement(loading);
            }
        }

        // Format transcript for display
        function formatTranscript(transcript) {
            const lines = transcript.split('\n').filter(line => line.trim());
            return lines.map(line => {
                const timeMatch = line.match(/^\[(\d+)s\]\s*(.+)$/);
                if (timeMatch) {
                    const [, time, text] = timeMatch;
                    const minutes = Math.floor(time / 60);
                    const seconds = time % 60;
                    const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    return {
                        time: formattedTime,
                        text: text,
                        searchText: text.toLowerCase()
                    };
                }
                return {
                    time: '',
                    text: line,
                    searchText: line.toLowerCase()
                };
            });
        }

        // Display transcript
        function displayTranscript(transcript, searchTerm = '') {
            const formattedLines = formatTranscript(transcript);
            const filteredLines = searchTerm 
                ? formattedLines.filter(line => line.searchText.includes(searchTerm.toLowerCase()))
                : formattedLines;

            transcriptContent.innerHTML = filteredLines.map(line => {
                let highlightedText = line.text;
                if (searchTerm) {
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    highlightedText = line.text.replace(regex, '<mark class="bg-yellow-300 text-black">$1</mark>');
                }
                
                return `
                    <div class="transcript-line flex py-2 px-3 rounded-lg transition-colors duration-200 cursor-pointer">
                        <span class="text-gray-400 font-mono text-sm mr-4 flex-shrink-0 w-16">${line.time}</span>
                        <span class="text-white">${highlightedText}</span>
                    </div>
                `;
            }).join('');

            // Update stats
            transcriptStats.textContent = `${filteredLines.length} segments`;
            if (searchTerm && filteredLines.length !== formattedLines.length) {
                transcriptStats.textContent += ` (${formattedLines.length} total)`;
            }
        }

        // Copy transcript to clipboard
        async function copyTranscript() {
            try {
                await navigator.clipboard.writeText(currentTranscript);
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-2"></i>Copied!';
                copyBtn.classList.add('bg-green-700');
                lucide.createIcons();
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('bg-green-700');
                    lucide.createIcons();
                }, 2000);
            } catch (err) {
                showError('Failed to copy transcript to clipboard');
            }
        }

        // Download transcript as file
        function downloadTranscript() {
            const blob = new Blob([currentTranscript], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcript_${currentVideoId}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Search functionality
        searchInput.addEventListener('input', (e) => {
            displayTranscript(currentTranscript, e.target.value);
        });

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const videoUrl = document.getElementById('videoUrl').value.trim();
            const language = document.getElementById('language').value;
            const origin = document.getElementById('origin').value;

            if (!videoUrl) {
                showError('Please enter a YouTube URL or video ID');
                return;
            }

            try {
                currentVideoId = extractVideoId(videoUrl);
                setLoading(true);

                // Call the backend API with better error handling
                const response = await fetch('/api/transcript', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        videoId: currentVideoId,
                        language,
                        origin
                    })
                });

                // Check if response is OK
                if (!response.ok) {
                    // Try to parse error message
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch (parseError) {
                        // If we can't parse JSON, it might be HTML (404 page)
                        const textResponse = await response.text();
                        if (textResponse.includes('<!DOCTYPE html>') || textResponse.includes('<html>')) {
                            errorMessage = 'API endpoint not found. The server may not be properly configured.';
                        } else {
                            errorMessage = textResponse.substring(0, 100) + '...';
                        }
                    }
                    throw new Error(errorMessage);
                }

                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('Non-JSON response:', textResponse.substring(0, 200));
                    throw new Error('Server returned non-JSON response. Check server configuration.');
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch transcript');
                }

                currentTranscript = data.transcript;
                
                // Update UI
                videoInfo.textContent = `Video ID: ${currentVideoId} | Language: ${language} | Type: ${origin}`;
                if (data.stats) {
                    transcriptStats.textContent = `${data.stats.segments} segments | ${data.stats.words} words | ${Math.floor(data.stats.duration / 60)}:${(data.stats.duration % 60).toString().padStart(2, '0')} duration`;
                }
                
                displayTranscript(currentTranscript);
                
                showElement(results);
                setLoading(false);

                // Scroll to results
                results.scrollIntoView({ behavior: 'smooth' });

            } catch (err) {
                setLoading(false);
                console.error('Fetch error:', err);
                showError(err.message);
            }
        });

        // Event listeners for action buttons
        copyBtn.addEventListener('click', copyTranscript);
        downloadBtn.addEventListener('click', downloadTranscript);

        // Sample video ID for demo
        document.getElementById('videoUrl').value = 'J1jm4MoZw5Y';

        // Check API status on page load
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/health');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('API returned non-JSON response');
                }
                
                const data = await response.json();
                
                if (data.status === 'ok' && data.hasCredentials) {
                    console.log('‚úÖ API is ready');
                } else if (data.status === 'ok' && !data.hasCredentials) {
                    showError('Oxylabs credentials not configured on the server. Please contact the administrator.');
                } else {
                    showError('API health check failed');
                }
            } catch (error) {
                console.error('API status check failed:', error);
                showError(`Cannot connect to API server: ${error.message}. Please make sure the server is running.`);
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            checkAPIStatus();
            
            // Add some sample video IDs for quick testing
            const sampleVideos = [
                { id: 'J1jm4MoZw5Y', title: 'iPhone Review' },
                { id: 'dQw4w9WgXcQ', title: 'Music Video' }
            ];
        });

        // Auto-expand results section when transcript is loaded
        function autoExpandResults() {
            const transcriptLines = document.querySelectorAll('.transcript-line');
            transcriptLines.forEach((line, index) => {
                line.style.animationDelay = `${index * 0.02}s`;
                line.classList.add('animate-fade-in');
            });
        }

        // Add fade-in animation CSS
        const style = document.createElement('style');
        style.textContent = `
            .animate-fade-in {
                animation: fadeIn 0.3s ease-in-out forwards;
                opacity: 0;
            }
            @keyframes fadeIn {
                to { opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>